# Living Collage Maker - 제품 요구사항 문서 (PRD)

## 1. 제품 개요

Living Collage Maker는 사용자가 가구를 드래그 앤 드롭으로 배치하여 인테리어 콜라주를 만들 수 있는 애플리케이션입니다. 사용자는 다양한 가구를 캔버스에 배치하고, 크기를 조절하며, 다중 선택을 통한 일괄 편집이 가능하고, 최종 결과물을 다양한 형식으로 저장할 수 있습니다. 🆕

## 2. 핵심 기능

### 2.1 가구 탐색 및 필터링
- 가구 목록을 테이블 형태로 표시
- 각 가구 항목은 썸네일, 브랜드, 이름, 가격 정보 포함
- 필터링 기능:
  - 검색어로 가구 검색
  - 브랜드별 필터링
  - 타입별 필터링
  - 가격대별 필터링

### 2.2 드래그 앤 드롭 기능
- 가구 목록에서 캔버스로 드래그 앤 드롭
- 드래그 시 가구 데이터를 MIME 데이터로 전송
- 드롭 시 가구 이미지를 캔버스에 표시
- 드롭된 가구는 자유롭게 이동 및 크기 조절 가능
  - 크기 조절 시 원본 비율 무시하고 자유롭게 변형 가능

### 2.2.2 가구 아이템 기능
- **기본 동작**
  - 드래그 앤 드롭으로 캔버스에 배치
  - 자유로운 위치 이동
  - 우클릭 메뉴로 삭제 및 좌우 반전 기능 제공
  - 최소 크기: 100x100 픽셀

- **다중 선택 기능** 🆕
  - **다중 선택 방법**
    - Ctrl 키 (Windows/Linux) 또는 Cmd 키 (macOS)를 누른 상태로 클릭하여 다중 선택
    - 선택된 아이템은 파란색 테두리로 표시
    - 다중 선택된 상태에서 이미 선택된 아이템을 클릭해도 다중 선택 유지
    - 빈 공간 클릭 시 모든 선택 해제 (Ctrl 키를 누르지 않은 경우)
  
  - **다중 선택 시 가능한 동작**
    - **동시 이동**: 선택된 모든 아이템이 함께 이동
    - **일괄 삭제**: 
      - 우클릭 메뉴의 "삭제" 선택 시 모든 선택된 아이템 삭제
      - Delete 키 또는 Backspace 키로 키보드 삭제
    - **개별 리사이즈**: 각 아이템은 개별적으로만 크기 조절 가능
  
  - **제한사항**
    - Ctrl/Cmd 키를 누른 상태에서는 드래그 이동 방지 (의도치 않은 이동 방지)
    - 이미지 조정, 좌우 반전 등의 기능은 개별 아이템에만 적용

- **경계 체크 시스템** 🆕
  - **이동 경계 체크**
    - 가구 이동 시 캔버스 영역을 벗어나지 않도록 제한
    - 다중 선택된 아이템들의 동시 이동에서도 경계 체크 적용
    - 모든 아이템이 캔버스 내에 유지되도록 이동량 자동 조정
  
  - **리사이즈 경계 체크**
    - 가구 크기 조절 시 캔버스 영역을 벗어나지 않도록 제한
    - 비율 유지 모드(Shift 키)에서도 경계 체크 적용
    - 경계 제한이 최소 크기 제한보다 우선 적용
    - 현재 위치와 캔버스 크기를 고려하여 최대 허용 크기 계산

- **크기 조절 기능**
  - 우측 하단의 리사이즈 핸들을 드래그하여 크기 조절
  - Shift 키를 누르지 않고 드래그:
    - 이미지가 위젯을 꽉 채우도록 자유롭게 크기 조절
    - 원본 이미지 비율 무시
  - Shift 키를 누른 상태로 드래그:
    - 원본 이미지 비율 유지
    - 이미지가 중앙에 배치되며 비율에 맞게 크기 조절
  - **경계 체크**: 크기 조절 시 캔버스 영역을 벗어나지 않도록 제한 🆕

- **이미지 표시**
  - 비율 유지 모드: 이미지가 중앙에 배치되며 원본 비율 유지
  - 비율 무시 모드: 이미지가 위젯을 꽉 채우도록 표시
  - 이미지 로드 실패 시 회색 배경에 오류 메시지 표시

- **이미지 조정 기능**
  - 색온도 조절: 이미지의 따뜻함/차가움 조절 (2000K-10000K)
  - 밝기 조절: 이미지의 밝기 조절 (0-200%, 기본값 100%)
  - 채도 조절: 이미지의 색상 강도 조절 (0-200%, 기본값 100%)
  - 이미지 조정 슬라이더 UI 제공
  - 초기화 버튼으로 원본 이미지 상태로 복원
  - 조정 상태 미리보기 제공

### 2.3 캔버스 관리
- 새 콜라주 생성 시 캔버스 크기 설정 가능
- 캔버스 크기에 맞춰 윈도우 크기 자동 조정
- 캔버스 테두리와 크기 표시
- 가구 아이템 우클릭 메뉴:
  - 삭제 기능
  - 좌우 반전 기능

### 2.4 이미지 관리
- 이미지 캐싱 시스템 구현
  - **크로스플랫폼 표준 캐시 디렉토리** 사용 (platformdirs 라이브러리)
    - Windows: `C:\Users\Username\AppData\Local\LivingCollageMaker\Cache`
    - macOS: `~/Library/Caches/LivingCollageMaker`
    - Linux: `~/.cache/LivingCollageMaker`
  - PNG 형식으로 저장
  - 메모리 캐시와 디스크 캐시 이중 구조
  - 약한 참조(Weak Reference)를 사용한 메모리 관리
  - 이미지 크기 최적화 (최대 1920px)
  - 이미지 품질 최적화 (85% 품질)
- 비동기 이미지 로딩
  - 스레드 풀을 사용한 병렬 처리
  - UI 블로킹 방지
  - 로딩 상태 관리
- 썸네일 생성 및 캐싱
- 이미지 로드 실패 시 기본 이미지 표시

### 2.5 하단 패널
- 선택된 가구 목록 표시
- 선택된 가구 수 표시
- 총 가격 계산 및 표시
- 가구 삭제 시 자동 업데이트

### 2.6 콜라주 내보내기
- 현재 콜라주를 이미지로 저장
- PNG/JPEG 형식 지원
- 저장 위치 선택 가능

### 2.8 콜라주 HTML로 내보내기
- **기본 기능**
  - 메뉴바의 "파일" 메뉴에 "콜라주 HTML로 내보내기" 항목 추가
  - 현재 콜라주와 가구 정보를 HTML 문서로 내보내기
  - HTML 파일 저장 위치 선택 가능
  - 콜라주 이미지를 별도 PNG 파일로 함께 저장

- **파일 저장 구조**
  - HTML 파일: 사용자가 선택한 위치에 저장 (예: `my_collage.html`)
  - 이미지 파일: HTML 파일과 같은 폴더에 저장 (예: `my_collage.png`)
  - HTML에서 상대 경로로 이미지 파일 참조

- **HTML 문서 구조**
  - **상단 영역**: 콜라주 이미지
    - 별도 저장된 PNG 파일을 `<img>` 태그로 참조
    - 적당한 크기로 표시 (너무 크지 않게 조정)
  - **하단 영역**: 가구 목록 정보
    - 콜라주에 사용된 모든 가구의 정보 표시
    - 작성자(author) 정보를 제외한 모든 Furniture 필드 포함

- **가구 정보 표시 내용**
  - 가구 이름 (name)
  - 브랜드 (brand) 
  - 타입 (type)
  - 가격 (price) - 원화 표시
  - 설명 (description)
  - 크기 정보 (width, depth, height) - mm 단위
  - 좌석 높이 (seat_height) - mm 단위, 해당하는 경우만
  - 제품 링크 - "제품 바로가기" 하이퍼링크

- **하이퍼링크 기능**
  - 가구의 link 필드가 있는 경우 "제품 바로가기" 텍스트로 표시
  - 클릭 시 새 탭에서 해당 링크로 이동 (`target="_blank"`)
  - 링크가 없는 경우 "링크 없음" 표시

- **HTML 스타일링**
  - 깔끔하고 읽기 쉬운 기본 레이아웃
  - 가구 정보는 1열 카드 형태로 구성
  - 기본 CSS 스타일 내장으로 외부 파일 의존성 없음
  - 이미지가 적당한 크기로 잘 보이도록 설정 (최대 너비 1200px)

### 2.10 콜라주 PDF로 내보내기
- **기본 기능**
  - 메뉴바의 "파일" 메뉴에 "콜라주 PDF로 내보내기" 항목 추가
  - 선택된 가구 정보와 콜라주 이미지를 포함한 전문적인 PDF 카탈로그 생성
  - PDF 파일 저장 위치 선택 가능
  - 임시 파일 의존성 없이 PDF 직접 생성

- **PDF 생성 워크플로**
  1. 선택된 가구 목록 정보 수집
  2. 콜라주 이미지를 PDF에 직접 임베딩
  3. reportlab을 사용하여 전문적인 PDF 문서 생성
  4. 사용자에게 저장 완료 알림

- **PDF 변환 기술**
  - `reportlab` 라이브러리 사용 (직접 PDF 생성)
  - **한글 폰트 지원**: 맑은 고딕 폰트 자동 등록 및 fallback 메커니즘
  - 고품질 이미지 임베딩 (BytesIO 방식)
  - 클릭 가능한 하이퍼링크 기능 (🔗 아이콘 포함)
  - 페이지 크기: A4

- **PDF 문서 구조**
  - **개별 섹션 형태**: 각 가구가 독립적인 섹션으로 구성
  - 번호가 있는 가구 제목 (1., 2., etc.)
  - 각 가구 정보:
    - 가구 이름, 브랜드, 타입
    - 가격 (원화 표시)
    - 설명 및 크기 정보
    - 클릭 가능한 제품 링크 (🔗 아이콘)
  - 가구 간 시각적 구분선
  - 푸터에 생성 정보 (날짜, 시간, 총 가구 수)

- **PDF 최적화**
  - 이미지를 PDF에 직접 임베딩하여 외부 파일 의존성 제거
  - 한글 텍스트 완벽 지원
  - 전문적인 레이아웃과 스타일링
  - 인터랙티브 하이퍼링크 지원

- **에러 처리**
  - 폰트 등록 실패시 기본 폰트 사용 fallback
  - PDF 생성 실패시 상세 오류 메시지 제공
  - 임시 파일 정리 보장

### 2.9 작업 내용 저장/불러오기
- **저장 데이터**
  - 캔버스 정보
    - 캔버스 크기 (width, height)
    - 작업 제목/설명
    - 저장 시간
    - 마지막 수정 시간
    - 작업 버전
  - 가구 정보
    - 데이터베이스 ID
    - 위치 (x, y 좌표)
    - 크기 (width, height)
    - z-order (레이어 순서)
    - 좌우 반전 여부
    - 이미지 조정 정보 (색온도, 밝기, 채도 값)

- **저장 형식**
  - JSON 형식으로 저장
  - 파일 확장자: .json

- **기능**
  - 작업 내용 저장
  - 작업 내용 불러오기

### 2.11 애플리케이션 상태 관리
- **자동 상태 저장/복원**
  - 종료 시 자동으로 애플리케이션 상태 저장
  - 시작 시 이전 상태 자동 복원
  - 크로스플랫폼 표준 캐시 디렉토리 사용

- **저장되는 상태 정보**
  - **윈도우 상태**: 창 크기, 위치
  - **패널 상태**: 스플리터 크기 (수평/수직)
  - **컬럼 너비**: 탐색 패널 및 하단 패널의 테이블 컬럼 너비
  - **캔버스 상태**: 캔버스 크기
  - **가구 아이템 상태**: 
    - 가구 ID, 위치, 크기, z-order
    - 좌우 반전 여부
    - 이미지 조정 정보 (색온도, 밝기, 채도)

- **상태 관리 기능**
  - 레이아웃 초기화: 모든 UI 설정을 기본값으로 복원
  - 캐시 정리: 앱 상태 및 이미지 캐시 삭제
  - 자동 마이그레이션: 기존 캐시에서 새 위치로 자동 이전

- **캐시 저장 위치**
  - Windows: `C:\Users\Username\AppData\Local\LivingCollageMaker\Cache\app_state.json`
  - macOS: `~/Library/Caches/LivingCollageMaker/app_state.json`
  - Linux: `~/.cache/LivingCollageMaker/app_state.json`

- **에러 처리**
  - 상태 파일 손상 시 기본값으로 fallback
  - 가구 데이터 누락 시 해당 아이템만 제외하고 복원
  - 복원 실패 시 상세 로그 제공

## 3. 기술 스택

### 3.1 프론트엔드
- PyQt6
- QTableView 및 QStandardItemModel
- QGraphicsView (향후 구현 예정)

### 3.2 백엔드
- Python
- Supabase (데이터베이스 및 이미지 저장)
- SQLite (로컬 캐시)
- reportlab (PDF 생성)
- platformdirs (크로스플랫폼 캐시 디렉토리)

## 4. 데이터 모델

### 4.1 가구 (Furniture)
```python
@dataclass
class Furniture:
    # 필수 필드
    id: str
    brand: str
    name: str
    image_filename: str
    price: int
    type: str
    
    # 선택적 필드 (기본값 설정)
    description: str = ''
    link: str = ''
    color: str = ''
    locations: List[str] = field(default_factory=list)
    styles: List[str] = field(default_factory=list)
    width: int = 0
    depth: int = 0
    height: int = 0
    seat_height: Optional[int] = None
    author: str = ''
    created_at: str = ''
```

## 5. UI/UX 디자인

### 5.1 레이아웃
- 메인 윈도우: 1200x800 기본 크기
- 캔버스: 사용자 정의 크기 (최소 800x600)
- 우측 패널: 400px 고정 너비
- 하단 패널: 200px 고정 높이

#### 메뉴바 구조
- **파일 메뉴**
  - 저장하기: 현재 작업 내용을 JSON 형식으로 저장
  - 불러오기: 저장된 작업 내용을 불러오기
  - 새 콜라주 만들기: 새로운 콜라주 작업 시작
  - 콜라주 내보내기: 현재 콜라주를 이미지로 저장
  - 콜라주 HTML로 내보내기: 콜라주와 가구 정보를 HTML 문서로 내보내기
  - 콜라주 PDF로 내보내기: 콜라주와 가구 정보를 PDF 문서로 내보내기
  - --- (구분선)
  - 레이아웃 초기화: 창 크기, 패널 크기, 컬럼 너비를 기본값으로 초기화
  - 앱 캐시 정리: 앱 상태 및 이미지 캐시 삭제

### 5.2 색상 테마
- 배경: 흰색 (#FFFFFF)
- 주요 색상: #2C3E50
- 강조 색상: #E74C3C (삭제 버튼)
- 테두리: #DDDDDD

## 6. 성능 요구사항
- 이미지 로딩 시간: 1초 이내
- 드래그 앤 드롭 반응성: 16ms 이내
- 필터링 응답 시간: 100ms 이내
- 메모리 사용량 최적화
  - 약한 참조를 사용한 메모리 관리
  - 이미지 크기 및 품질 최적화
  - 비동기 로딩으로 UI 반응성 유지

## 7. 향후 개선사항 (To-do List)

### 7.1 우선순위 높음
- [x] 이미지 최적화 및 캐시 관리 개선
- [x] 에러 처리 및 사용자 피드백 강화
- [x] 가구 좌우 반전 기능 구현
- [x] 가구 다중 선택 기능 구현 🆕
  - [x] Ctrl/Cmd 키를 이용한 다중 선택 시스템
  - [x] 다중 선택된 아이템들의 동시 이동 기능
  - [x] 다중 선택된 아이템들의 일괄 삭제 기능
  - [x] Delete/Backspace 키를 이용한 키보드 삭제
  - [x] 선택 상태 유지 로직 개선
- [x] 캔버스 경계 체크 시스템 구현 🆕
  - [x] 가구 이동 시 캔버스 영역 벗어남 방지
  - [x] 가구 리사이즈 시 캔버스 영역 벗어남 방지
  - [x] 다중 선택 이동에서의 경계 체크
  - [x] 비율 유지 모드에서의 경계 체크
- [ ] 가구 회전 기능 구현
- [ ] 가구 크기 조절 시 그리드 스냅 기능
- [x] 가구 이미지 색온도, 밝기, 채도 조절 기능
- [x] 작업 내용 저장/불러오기 기능
  - [x] 기본 저장/불러오기 구현
  - [x] 이미지 조정 정보 저장/불러오기 구현
- [x] 콜라주 HTML로 내보내기 기능
  - [x] HTML 문서 생성 기능 구현
  - [x] 콜라주 이미지 별도 파일 저장 기능
  - [x] 가구 정보 표시 및 하이퍼링크 기능
  - [x] 기본 CSS 스타일링 적용
- [x] 콜라주 PDF로 내보내기 기능
  - [x] reportlab 라이브러리 통합
  - [x] 직접 PDF 생성 서비스 구현
  - [x] 한글 폰트 지원 및 fallback 메커니즘
  - [x] 이미지 임베딩 및 하이퍼링크 기능
  - [x] 전문적인 레이아웃 및 스타일링
- [x] 애플리케이션 상태 관리 기능
  - [x] 자동 상태 저장/복원 시스템 구현
  - [x] 크로스플랫폼 캐시 디렉토리 사용
  - [x] 윈도우, 패널, 컬럼 너비, 캔버스 상태 저장
  - [x] 가구 아이템 상태 저장 (위치, 크기, 이미지 조정 등)
  - [x] 레이아웃 초기화 및 캐시 정리 기능
  - [x] 에러 처리 및 fallback 메커니즘

### 7.2 우선순위 중간
- [ ] 가구 배치 히스토리 (실행 취소/다시 실행)
- [ ] 가구 그룹화 기능
- [ ] 가구 정렬 기능
- [ ] 가구 복제 기능
- [ ] 가구 레이어 관리

### 7.3 우선순위 낮음
- [ ] 3D 뷰 모드
- [ ] 가구 커스터마이징 기능
- [ ] 가구 추천 시스템
- [ ] 공유 기능
- [ ] 가구 가격 비교 기능

## 8. 제한사항
- 최대 캔버스 크기: 4000x4000 픽셀
- 최대 가구 개수: 100개
- 지원 이미지 형식: JPG, PNG
- 최대 이미지 크기: 5MB
- 이미지 최적화: 최대 1920px, 85% 품질

## 9. 테스트 요구사항
- **단위 테스트**: 모든 핵심 기능 (총 152개 테스트) 🆕
  - 가구 데이터 모델 테스트
  - 서비스 레이어 테스트 (이미지, PDF, HTML, 상태 관리)
  - UI 컴포넌트 테스트 (캔버스, 패널, 위젯)
  - 다중 선택 기능 테스트 🆕
  - 경계 체크 시스템 테스트 🆕
- **통합 테스트**: 데이터베이스 연동
- **UI 테스트**: 모든 사용자 상호작용
  - 드래그 앤 드롭 테스트
  - 키보드 이벤트 테스트 (Delete/Backspace) 🆕
  - 마우스 이벤트 테스트 (다중 선택, 경계 체크) 🆕
- **성능 테스트**: 대용량 데이터 처리
- **메모리 누수 테스트**
- **스레드 안전성 테스트**

## 10. 배포 요구사항
- Python 3.8 이상
- PyQt6 6.4.0 이상
- Supabase 클라이언트 라이브러리
- reportlab (PDF 내보내기용)
- platformdirs (크로스플랫폼 캐시 디렉토리)
- 인터넷 연결 필요
- 최소 4GB RAM
- 최소 1GB 저장 공간 